service:
  name: yyt-chat

plugins:
  - serverless-webpack
  - serverless-offline

provider:
  name: aws
  runtime: nodejs8.10
  region: ap-northeast-2
  iamRoleStatements:
    - Effect: Allow
      Action:
        - 'execute-api:ManageConnections'
      Resource:
        - 'arn:aws:execute-api:*:*:**/@connections/*'

functions:
  seeTopicMembers:
    handler: src/admin/handler.seeTopicMembers
    events:
      - http:
          method: get
          path: redis/{topic}
    environment:
      REDIS_HOST: ${env:REDIS_HOST}
      REDIS_PASSWORD: ${env:REDIS_PASSWORD}
  deleteTopic:
    handler: src/admin/handler.deleteTopic
    events:
      - http:
          method: delete
          path: redis/{topic}
    environment:
      REDIS_HOST: ${env:REDIS_HOST}
      REDIS_PASSWORD: ${env:REDIS_PASSWORD}
  connect:
    handler: src/ws/handler.connect
    events:
      - websocket:
          route: $connect
    environment:
      REDIS_HOST: ${env:REDIS_HOST}
      REDIS_PASSWORD: ${env:REDIS_PASSWORD}
  disconnect:
    handler: src/ws/handler.disconnect
    events:
      - websocket:
          route: $disconnect
    environment:
      REDIS_HOST: ${env:REDIS_HOST}
      REDIS_PASSWORD: ${env:REDIS_PASSWORD}
  defaultMessages:
    handler: src/ws/handler.defaultMessages
    events:
      - websocket:
          route: $default
    environment:
      REDIS_HOST: ${env:REDIS_HOST}
      REDIS_PASSWORD: ${env:REDIS_PASSWORD}
  subscribeTopic:
    handler: src/ws/handler.subscribeTopic
    events:
      - websocket:
          route: subscribe
    environment:
      REDIS_HOST: ${env:REDIS_HOST}
      REDIS_PASSWORD: ${env:REDIS_PASSWORD}
  unsubscribeTopic:
    handler: src/ws/handler.unsubscribeTopic
    events:
      - websocket:
          route: unsubscribe
    environment:
      REDIS_HOST: ${env:REDIS_HOST}
      REDIS_PASSWORD: ${env:REDIS_PASSWORD}
  broadcastMessage:
    handler: src/ws/handler.broadcastMessage
    events:
      - websocket:
          route: broadcast
    environment:
      REDIS_HOST: ${env:REDIS_HOST}
      REDIS_PASSWORD: ${env:REDIS_PASSWORD}
